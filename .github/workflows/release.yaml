name: Build and Release FFmpeg

on:
  push:
    tags:
      - 'v*'  # 仅在推送标签时触发
  workflow_dispatch:  # 允许手动触发

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v2

    - name: Set up dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          autoconf \
          automake \
          build-essential \
          cmake \
          git-core \
          libass-dev \
          libfreetype6-dev \
          libsdl2-dev \
          libtool \
          libva-dev \
          libvdpau-dev \
          libvorbis-dev \
          libxcb1-dev \
          libxcb-shm0-dev \
          libxcb-xfixes0-dev \
          meson \
          ninja-build \
          pkg-config \
          texinfo \
          wget \
          yasm \
          zlib1g-dev

    - name: Download and extract FFmpeg
      run: |
        wget https://ffmpeg.org/releases/ffmpeg-4.4.tar.bz2
        tar xjf ffmpeg-4.4.tar.bz2
        cd ffmpeg-4.4

    - name: Configure FFmpeg
      run: |
        cd ffmpeg-4.4
        ./configure --prefix=/usr/local --enable-gpl --enable-libass --enable-libfreetype --enable-libvorbis --enable-libvpx --enable-libx264 --enable-libx265 --enable-nonfree

    - name: Build FFmpeg
      run: |
        cd ffmpeg-4.4
        make -j$(nproc)

    - name: Package FFmpeg
      run: |
        cd ffmpeg-4.4
        make install DESTDIR=$GITHUB_WORKSPACE/ffmpeg-build
        cd $GITHUB_WORKSPACE
        tar -czvf ffmpeg-4.4.tar.gz ffmpeg-build/usr/local

    - name: Create Release
      id: create_release
      uses: actions/create-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ github.ref }}
        release_name: Release ${{ github.ref }}
        draft: false
        prerelease: false

    - name: Upload Release Asset
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ steps.create_release.outputs.upload_url }}
        asset_path: ffmpeg-4.4.tar.gz
        asset_name: ffmpeg-4.4.tar.gz
        asset_content_type: application/gzip
